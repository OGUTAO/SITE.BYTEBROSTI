<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADM Loja de Peças - Byte Bros</title>
    <link rel="stylesheet" href="css/style6.css">
</head>
<body>
    <div class="container">
        <button id="theme-toggle" class="button theme-toggle-button" title="Alternar Tema">
            </button>

        <h2>Adicionar Novo Produto</h2>
        <form id="add-product-form" class="product-form">
            <div class="form-group">
                <label for="new-product-name">Nome:</label>
                <input type="text" id="new-product-name" required>
            </div>
            <div class="form-group">
                <label for="new-product-details">Detalhes:</label>
                <textarea id="new-product-details"></textarea>
            </div>
            <div class="form-group">
                <label for="new-product-value">Valor (Ex: 99.90):</label>
                <input type="number" step="0.01" min="0" id="new-product-value" placeholder="99.90" required>
            </div>
            <div class="form-group">
                <label for="new-product-quantity">Quantidade:</label>
                <input type="number" id="new-product-quantity" value="1" min="0" required>
            </div>
            <div class="form-group">
                <label for="new-product-image">URL da Imagem:</label>
                <input type="text" id="new-product-image" placeholder="Ex: img/nova_peca.jpg">
            </div>
            <button type="submit" class="button submit-button">Adicionar Produto</button>
        </form>

        <hr>

        <h2>Peças Disponíveis</h2>
        <ul class="product-list"></ul>

        <a href="lojapecascliente.html" class="button temp-button">Acessar Loja como Cliente</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Seletores de Elementos ---
            const addProductForm = document.getElementById('add-product-form');
            const productList = document.querySelector('.product-list');
            const themeToggleButton = document.getElementById('theme-toggle');

            // --- Estado da Aplicação ---
            let products = loadProductsFromLocalStorage();

            // --- Funções de Persistência (LocalStorage) ---
            function saveProductsToLocalStorage(productsToSave) {
                localStorage.setItem('products', JSON.stringify(productsToSave));
            }

            function loadProductsFromLocalStorage() {
                const storedProducts = localStorage.getItem('products');
                return storedProducts ? JSON.parse(storedProducts) : [];
            }

            // --- Renderização da Lista de Produtos ---
            function renderAdminProducts(productsToRender) {
                productList.innerHTML = ''; // Limpa a lista antes de renderizar
                if (!productsToRender || productsToRender.length === 0) {
                    productList.innerHTML = '<li class="no-products-message">Nenhuma peça cadastrada ainda.</li>'; // Mensagem se vazio
                    return;
                }

                productsToRender.forEach((product, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('product-item');
                    listItem.dataset.productId = product.id || index;

                    const valueAsNumber = parseFloat(product.value);
                    const formattedValue = !isNaN(valueAsNumber)
                        ? valueAsNumber.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                        : 'Valor inválido';

                    // **ESTRUTURA ATUALIZADA AQUI para .stats e .action-buttons**
                    listItem.innerHTML = `
                        <div class="product-info">
                            <div class="product-name">${product.name || 'Nome Indefinido'}</div>
                            <div class="product-details">${product.details || 'Sem detalhes'}</div>
                        </div>
                        <div class="product-actions">
                            <div class="stats">
                                <span class="product-value">Valor: ${formattedValue}</span>
                                <span class="product-quantity">Quantidade: ${product.quantity || 0}</span>
                            </div>
                            <div class="action-buttons">
                                <button class="button edit-button" data-index="${index}" title="Editar Produto">Editar</button>
                                <button class="button delete-button danger" data-index="${index}" title="Excluir Produto">Excluir</button>
                            </div>
                        </div>
                        <div class="edit-controls">
                            <div class="edit-control-group">
                                <label for="value-${index}">Novo Valor (Ex: 1800.00):</label>
                                <input type="number" step="0.01" min="0" id="value-${index}" value="${product.value || ''}">
                            </div>
                            <div class="edit-control-group">
                                <label for="quantity-${index}">Nova Qtd:</label>
                                <input type="number" id="quantity-${index}" value="${product.quantity || 0}" min="0">
                            </div>
                            <div class="edit-action-buttons">
                                <button class="button save" data-index="${index}">Salvar</button>
                                <button class="button cancel" data-index="${index}">Cancelar</button>
                            </div>
                        </div>
                    `;
                    productList.appendChild(listItem);
                });

                attachAdminEventListeners(); // (Re)liga eventos aos botões criados
            }

            // --- Lógica de Eventos da Lista ---
            function attachAdminEventListeners() {
                productList.querySelectorAll('.edit-button').forEach(button => {
                    // Remove listener antigo para evitar duplicação se já existir
                    button.removeEventListener('click', handleEditClick);
                    button.addEventListener('click', handleEditClick);
                });
                productList.querySelectorAll('.save').forEach(button => {
                    button.removeEventListener('click', handleSaveClick);
                    button.addEventListener('click', handleSaveClick);
                });
                productList.querySelectorAll('.cancel').forEach(button => {
                    button.removeEventListener('click', handleCancelClick);
                    button.addEventListener('click', handleCancelClick);
                });
                productList.querySelectorAll('.delete-button').forEach(button => {
                    button.removeEventListener('click', handleDeleteClick);
                    button.addEventListener('click', handleDeleteClick);
                });
            }

            function handleEditClick(event) {
                const button = event.currentTarget;
                const listItem = button.closest('.product-item');
                if (!listItem) return;
                const editControls = listItem.querySelector('.edit-controls');
                const productActions = listItem.querySelector('.product-actions');

                closeAllEditControls(listItem); // Fecha outros abertos

                if (editControls) editControls.classList.add('active');
                if (productActions) productActions.style.display = 'none';
            }

            function handleSaveClick(event) {
                const button = event.currentTarget;
                const listItem = button.closest('.product-item');
                if (!listItem) return;
                const index = parseInt(button.dataset.index);
                const editControls = listItem.querySelector('.edit-controls');
                const newValueInput = editControls.querySelector(`#value-${index}`);
                const newQuantityInput = editControls.querySelector(`#quantity-${index}`);

                const newValue = parseFloat(newValueInput.value);
                const newQuantity = parseInt(newQuantityInput.value);

                if (isNaN(newValue) || newValue < 0 || isNaN(newQuantity) || newQuantity < 0) {
                    alert("Por favor, insira valores válidos para Valor (número positivo) e Quantidade (número inteiro positivo).");
                    return;
                }

                // Atualiza o array 'products'
                products = products.map((product, i) => {
                    if (i === index) {
                        return { ...product, value: newValue.toFixed(2), quantity: newQuantity };
                    }
                    return product;
                });

                saveProductsToLocalStorage(products);
                renderAdminProducts(products); // Re-renderiza com dados atualizados
                alert(`Produto atualizado!`);
            }

            function handleCancelClick(event) {
                const button = event.currentTarget;
                const listItem = button.closest('.product-item');
                if (!listItem) return;
                const editControls = listItem.querySelector('.edit-controls');
                const productActions = listItem.querySelector('.product-actions');

                if (editControls) editControls.classList.remove('active');
                if (productActions) productActions.style.display = 'flex'; // Ou 'block' dependendo do seu CSS base
            }

            function handleDeleteClick(event) {
                const button = event.currentTarget;
                const indexToDelete = parseInt(button.dataset.index);
                // Encontra o produto pelo índice para pegar o nome (cuidado se a ordem mudar)
                const productToDelete = products[indexToDelete];
                const productName = productToDelete ? productToDelete.name : `Item ${indexToDelete + 1}`;


                if (confirm(`Tem certeza que deseja excluir "${productName}"?`)) {
                    // Filtra o array, mantendo todos EXCETO o do índice a ser deletado
                    products = products.filter((_, index) => index !== indexToDelete);
                    saveProductsToLocalStorage(products);
                    renderAdminProducts(products);
                    alert(`"${productName}" foi excluído!`);
                }
            }

            function closeAllEditControls(excludeItem = null) {
                productList.querySelectorAll('.product-item').forEach(item => {
                    if (item === excludeItem) return;
                    const editControls = item.querySelector('.edit-controls');
                    const productActions = item.querySelector('.product-actions');
                    if (editControls) editControls.classList.remove('active');
                    if (productActions) productActions.style.display = 'flex'; // Garante que ações voltem
                });
            }

            // --- Lógica do Formulário de Adicionar Produto ---
            if (addProductForm) {
                addProductForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const nameInput = document.getElementById('new-product-name');
                    const detailsInput = document.getElementById('new-product-details');
                    const valueInput = document.getElementById('new-product-value');
                    const quantityInput = document.getElementById('new-product-quantity');
                    const imageInput = document.getElementById('new-product-image');

                    const value = parseFloat(valueInput.value);
                    const quantity = parseInt(quantityInput.value);

                    if (!nameInput.value.trim()) {
                        alert("O nome do produto é obrigatório.");
                        nameInput.focus();
                        return;
                    }
                    if (isNaN(value) || value < 0) {
                        alert("Por favor, insira um valor monetário válido (Ex: 99.90).");
                        valueInput.focus();
                        return;
                    }
                     if (isNaN(quantity) || quantity < 0) {
                        alert("Por favor, insira uma quantidade válida (número inteiro positivo).");
                        quantityInput.focus();
                        return;
                    }

                    const newProduct = {
                        id: Date.now().toString(), // ID único simples
                        name: nameInput.value.trim(),
                        details: detailsInput.value.trim(),
                        value: value.toFixed(2),
                        quantity: quantity,
                        image: imageInput.value.trim()
                    };

                    products.push(newProduct); // Adiciona ao array local
                    saveProductsToLocalStorage(products); // Salva no localStorage
                    renderAdminProducts(products); // Atualiza a lista na tela
                    addProductForm.reset(); // Limpa o formulário
                    alert(`"${newProduct.name}" adicionado com sucesso!`);
                });
            } else {
                console.warn("Formulário #add-product-form não encontrado.");
            }


            // --- Lógica do Tema Claro/Escuro ---
            const sunIcon = '☀️'; // Ícone Sol
            const moonIcon = '🌙'; // Ícone Lua

            function setTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    if (themeToggleButton) themeToggleButton.innerHTML = sunIcon;
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    if (themeToggleButton) themeToggleButton.innerHTML = moonIcon;
                    localStorage.setItem('theme', 'light');
                }
            }

            function toggleTheme() {
                if (document.body.classList.contains('dark-mode')) {
                    setTheme('light');
                } else {
                    setTheme('dark');
                }
            }

            function loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                // Verifica também a preferência do sistema operacional
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

                if (savedTheme) {
                    setTheme(savedTheme);
                } else if (prefersDark) {
                    setTheme('dark');
                } else {
                    setTheme('light'); // Padrão
                }
            }

            // --- Inicialização Geral ---
            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', toggleTheme);
            } else {
                console.warn("Botão de tema #theme-toggle não encontrado.");
            }

            loadTheme(); // Carrega tema preferido/salvo
            renderAdminProducts(products); // Renderiza a lista inicial

        }); // Fim do DOMContentLoaded
    </script>
</body>
</html>